#!/bin/bash

display_changes=0
config_changes=0
kiosk_display="$SNAP_DATA/ubuntu-core-kiosk.display"
kiosk_config="$SNAP_DATA/ubuntu-core-kiosk.config"

# Ensure we have a config file with the fixed options
if [ ! -e "${kiosk_config}" ]; then
cat <<EOT > "${kiosk_config}"
arw-file=
console-provider=vt
EOT
let config_changes+=1
fi

# As mir-kiosk HAS to run mesa-kms we can safely override the probe for KMS everywhere.
# This ensures the best possible diagnostics whenever we fail to start.
env_hacks=$(sed -n 's/^env-hacks=\(.*\)$/\1/p' ${kiosk_config})
if [[ ! ${env_hacks} =~ .*MIR_MESA_KMS_DISABLE_MODESET_PROBE* ]]
then
  sed --in-place '/^env-hacks=/d' ${kiosk_config}
  env_hacks=env-hacks=${env_hacks}:MIR_MESA_KMS_DISABLE_MODESET_PROBE
  echo ${env_hacks/=:/=} >> "${kiosk_config}"
  let config_changes+=1
fi

# display-config
if display_config=$(snapctl get display-config); then
  if [ -n "${display_config}" ]; then
    echo "# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN" > "${kiosk_display}~"
    echo "# USE 'snap set mir-kiosk display-config=...' INSTEAD"              >> "${kiosk_display}~"
    echo ""                                                                   >> "${kiosk_display}~"
    echo "${display_config}"                                                  >> "${kiosk_display}~"
    if [ -e "${kiosk_display}" ]; then
      if ! diff "${kiosk_display}~" "${kiosk_display}" > /dev/null; then
        mv "${kiosk_display}"  "${kiosk_display}.save"
        mv "${kiosk_display}~" "${kiosk_display}"
        let display_changes+=1
      else
        rm "${kiosk_display}~"
      fi
    else
      mv "${kiosk_display}~" "${kiosk_display}"
      let display_changes+=1
    fi
  else
    if [ -e "${kiosk_display}" ]; then
      if grep "# USE 'snap set mir-kiosk display-config=...' INSTEAD" "${kiosk_display}"; then
        mv "${kiosk_display}"  "${kiosk_display}.save"
        let display_changes+=1
      fi
    fi
  fi
fi

# display-layout
display_layout=$(snapctl get display-layout)
if [ -n "${display_layout}" ]; then
  if [ -e "${kiosk_display}" ]; then
    if [ -z "$(grep "^  ${display_layout}:" "${kiosk_display}")" ]; then
      echo "ERROR: '$display_layout' is not a layout in ${kiosk_display}:"
      echo "---"
      cat "${kiosk_display}"
      echo "---"
      exit 1
    fi
  else
    if [ "${display_layout}" != "default" ]; then
      echo "ERROR: '$display_layout' is not a layout in ${kiosk_display}:"
      echo "---"
      cat "${kiosk_display}"
      echo "---"
      exit 1
    fi
  fi

  if [ "display-layout=${display_layout}" != "$(grep \^display-layout= ${kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^display-layout=/d' ${kiosk_config}
    else
      sed --in-place=.save '/^display-layout=/d' ${kiosk_config}
    fi
    echo display-layout=${display_layout} >> ${kiosk_config}
    let config_changes+=1
  fi
fi

# vt
vt=$(snapctl get vt)
if [ -n "${vt}" ]; then
  if [ -n "${vt//[0-9]}" ] || [ ! -e "/dev/tty$vt" ]; then
    echo "ERROR: '$vt' is not a valid VT"
    exit 1
  fi

  if [ "vt=${vt}" != "$(grep vt= ${kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^vt/d' ${kiosk_config}
    else
      sed --in-place=.save '/^vt/d' ${kiosk_config}
    fi
    echo vt=${vt} >> ${kiosk_config}
    let config_changes+=1
  fi
fi

# cursor
cursor=$(snapctl get cursor)
if [ -n "${cursor}" ]; then
  if [[ ! "${cursor}" =~ ^(auto|none|software)$ ]]; then
    echo "ERROR: '$cursor' is not a valid cursor option (auto|none|software)"
    exit 1
  fi

  if [ "${cursor}" == "none" ]; then
    cursor="null"
  fi

  if [ "cursor=${cursor}" != "$(grep cursor= ${kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^cursor/d' ${kiosk_config}
    else
      sed --in-place=.save '/^cursor/d' ${kiosk_config}
    fi
    echo cursor=${cursor} >> ${kiosk_config}
    let config_changes+=1
  fi
fi

# show-splash 
showsplash=$(snapctl get show-splash)
if [ -n "${showsplash}" ]; then
  if [[ ! "${showsplash}" =~ ^(true|false)$ ]]; then
    echo "ERROR: '$showsplash' is not a valid cursor option (true|false)"
    exit 1
  fi

  if [ "show-splash=${showsplash}" != "$(grep show-splash= ${kiosk_config})" ]; then
    if [ $config_changes -gt 0 ]; then
      sed '/^show-splash/d' ${kiosk_config}
    else
      sed --in-place=.save '/^show-splash/d' ${kiosk_config}
    fi
    echo show-splash=${showsplash} >> ${kiosk_config}
    let config_changes+=1
  fi
fi

if [ "$(snapctl get daemon)" = "true" ]; then
  if snapctl services ${SNAP_NAME}.daemon | grep -q inactive; then
    snapctl start --enable $SNAP_NAME.daemon 2>&1 || true
  elif [ $(($config_changes+$display_changes)) -gt 0 ]; then
    snapctl restart $SNAP_NAME || true
  fi
else
  snapctl stop --disable $SNAP_NAME.daemon 2>&1 || true
fi
